<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Token Export</title>
    <link rel="stylesheet" href="ui.css" />
    <style>
      /* Token Export Plugin UI Styles */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 14px;
        line-height: 1.4;
        color: #333;
        background-color: #f5f5f5;
      }

      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 100%;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      /* Content */
      .content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      /* Section */
      .section {
        background: white;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }

      .section-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .section-controls {
        display: flex;
        gap: 8px;
      }

      .select-all-btn,
      .deselect-all-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        color: #666;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .select-all-btn:hover,
      .deselect-all-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th {
        background-color: #f8f9fa;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .data-table td {
        padding: 8px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
      }

      .data-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .checkbox-col {
        width: 40px;
        text-align: center;
      }

      /* Checkboxes */
      input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .select-all-checkbox {
        margin: 0;
      }

      /* Value display */
      .value-cell {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 12px;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
      }

      .color-value {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .color-swatch {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid #ddd;
        flex-shrink: 0;
      }

      /* Footer */
      .footer {
        background: white;
        border-top: 1px solid #e9ecef;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .export-controls {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .export-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .export-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .export-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .selection-count {
        font-size: 13px;
        color: #666;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .section-header {
          flex-direction: column;
          gap: 12px;
          align-items: flex-start;
        }

        .section-controls {
          width: 100%;
          justify-content: space-between;
        }

        .footer {
          flex-direction: column;
          gap: 12px;
          align-items: stretch;
        }

        .export-controls {
          justify-content: space-between;
        }
      }

      /* Scrollbar styling */
      .table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .table-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* Loading state */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #666;
      }

      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .empty-state h3 {
        margin-bottom: 8px;
        color: #333;
      }

      /* Type badges */
      .type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .type-color {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .type-number {
        background-color: #f3e5f5;
        color: #7b1fa2;
      }

      .type-boolean {
        background-color: #e8f5e8;
        color: #388e3c;
      }

      .type-string {
        background-color: #fff3e0;
        color: #f57c00;
      }

      .type-dropShadow {
        background-color: #fce4ec;
        color: #c2185b;
      }

      .type-innerShadow {
        background-color: #f1f8e9;
        color: #689f38;
      }

      .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Token Export</h1>
        <p>Select the design tokens and styles you want to export</p>
      </header>

      <div class="content" style="position:relative;">
        <div class="loading-overlay" id="loading-overlay" style="display:none;">
          <div class="loading">Loading design tokens...</div>
        </div>
        <!-- Variables Section -->
        <section class="section" id="variables-section">
          <div class="section-header">
            <h2>Variables</h2>
            <div class="section-controls">
              <button class="select-all-btn" data-section="variables">
                Select All
              </button>
              <button class="deselect-all-btn" data-section="variables">
                Deselect All
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="variables-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input
                      type="checkbox"
                      id="variables-select-all"
                      class="select-all-checkbox"
                    />
                  </th>
                  <th>Collection</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Value</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="variables-tbody">
                <!-- Variables will be populated here -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Text Styles Section -->
        <section class="section" id="textStyles-section">
          <div class="section-header">
            <h2>Text Styles</h2>
            <div class="section-controls">
              <button class="select-all-btn" data-section="textStyles">
                Select All
              </button>
              <button class="deselect-all-btn" data-section="textStyles">
                Deselect All
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="textStyles-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input
                      type="checkbox"
                      id="textStyles-select-all"
                      class="select-all-checkbox"
                    />
                  </th>
                  <th>Name</th>
                  <th>Font Family</th>
                  <th>Size</th>
                  <th>Weight</th>
                  <th>Line Height</th>
                </tr>
              </thead>
              <tbody id="textStyles-tbody">
                <!-- Text styles will be populated here -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Shadows Section -->
        <section class="section" id="shadows-section">
          <div class="section-header">
            <h2>Shadow Styles</h2>
            <div class="section-controls">
              <button class="select-all-btn" data-section="shadows">
                Select All
              </button>
              <button class="deselect-all-btn" data-section="shadows">
                Deselect All
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="shadows-table">
              <thead>
                <tr>
                  <th class="checkbox-col">
                    <input
                      type="checkbox"
                      id="shadows-select-all"
                      class="select-all-checkbox"
                    />
                  </th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Color</th>
                  <th>Offset</th>
                  <th>Blur</th>
                  <th>Spread</th>
                </tr>
              </thead>
              <tbody id="shadows-tbody">
                <!-- Shadows will be populated here -->
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div class="export-controls">
          <button id="export-btn" class="export-btn" disabled>
            Export Selected
          </button>
          <span id="selection-count" class="selection-count"
            >0 items selected</span
          >
        </div>
      </footer>
    </div>
    <script>

      class TokenExportUI {
        constructor() {
          this.exportData = null;
          this.selectedItems = {
            variables: new Set(),
            textStyles: new Set(),
            shadows: new Set(),
          };

          this.init();
        }

        init() {
          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              this.setupEventListeners();
              this.showLoading();
            });
          } else {
            this.setupEventListeners();
            this.showLoading();
          }
        }

        setupEventListeners() {
          // Listen for messages from the plugin
          window.addEventListener("message", (event) => {
            const { type, data } = event.data.pluginMessage || {};

            if (type === "export-data") {
              this.exportData = data;
              this.renderData();
            }
          });

          // Export button
          const exportBtn = document.getElementById("export-btn");
          if (exportBtn) {
            exportBtn.addEventListener("click", () => {
              this.exportSelected();
            });
          }

          // Select all checkboxes
          document.querySelectorAll(".select-all-checkbox").forEach((checkbox) => {
            checkbox.addEventListener("change", (e) => {
              const section = e.target.id.replace("-select-all", "");
              this.toggleSelectAll(section, e.target.checked);
            });
          });

          // Select all buttons
          document.querySelectorAll(".select-all-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const section = e.target.dataset.section;
              this.selectAll(section);
            });
          });

          // Deselect all buttons
          document.querySelectorAll(".deselect-all-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const section = e.target.dataset.section;
              this.deselectAll(section);
            });
          });
        }

        showLoading() {
          const overlay = document.getElementById("loading-overlay");
          if (overlay) overlay.style.display = "flex";
        }

        hideLoading() {
          const overlay = document.getElementById("loading-overlay");
          if (overlay) overlay.style.display = "none";
        }

        renderData() {
          if (!this.exportData) return;
          this.hideLoading();
          this.renderVariables();
          this.renderTextStyles();
          this.renderShadows();
          this.updateSelectionCount();
        }

        renderVariables() {
          const tbody = document.getElementById("variables-tbody");
          if (!tbody) {
            console.error("variables-tbody element not found");
            return;
          }
          
          const variables = this.exportData.variables;

          console.log(variables);

          if (Object.keys(variables).length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state"><h3>No variables found</h3><p>Create variables in your Figma file to see them here.</p></td></tr>';
            return;
          }

          let html = "";

          Object.entries(variables).forEach(([collectionName, collectionVars]) => {
            Object.entries(collectionVars).forEach(([varName, varData]) => {
              const itemId = `var_${collectionName}_${varName}`;
              const isSelected = this.selectedItems.variables.has(itemId);

              html += `
                          <tr data-id="${itemId}" data-section="variables">
                              <td class="checkbox-col">
                                  <input type="checkbox" ${
                                    isSelected ? "checked" : ""
                                  } data-id="${itemId}">
                              </td>
                              <td>${this.escapeHtml(collectionName)}</td>
                              <td>${this.escapeHtml(varName)}</td>
                              <td><span class="type-badge type-${varData.type}">${
                varData.type
              }</span></td>
                              <td>${this.renderValue(
                                varData.value,
                                varData.type
                              )}</td>
                              <td>${
                                varData.description
                                  ? this.escapeHtml(varData.description)
                                  : "-"
                              }</td>
                          </tr>
                      `;
            });
          });
          

          tbody.innerHTML = html;
          this.setupCheckboxListeners("variables");
        }

        renderTextStyles() {
          const tbody = document.getElementById("textStyles-tbody");
          if (!tbody) {
            console.error("textStyles-tbody element not found");
            return;
          }
          
          const textStyles = this.exportData.textStyles;

          if (Object.keys(textStyles).length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty-state"><h3>No text styles found</h3><p>Create text styles in your Figma file to see them here.</p></td></tr>';
            return;
          }

          let html = "";

          Object.entries(textStyles).forEach(([styleName, styleData]) => {
            // Sanitize styleName for use as an ID
            const safeStyleName = styleName.replace(/[^a-zA-Z0-9_-]/g, '_');
            const itemId = `text_${safeStyleName}`;
            console.log(itemId, this.selectedItems.textStyles);
            const isSelected = this.selectedItems.textStyles.has(itemId);

            html += `
                      <tr data-id="${itemId}" data-section="textStyles">
                          <td class="checkbox-col">
                              <input type="checkbox" ${
                                isSelected ? "checked" : ""
                              } data-id="${itemId}">
                          </td>
                          <td>${this.escapeHtml(styleName)}</td>
                          <td>${this.escapeHtml(styleData.fontFamily)}</td>
                          <td>${styleData.fontSize}px</td>
                          <td>${styleData.fontWeight}</td>
                          <td>${this.renderLineHeight(styleData.lineHeight)}</td>
                      </tr>
                  `;
          });

          tbody.innerHTML = html;
          this.setupCheckboxListeners("textStyles");
        }

        renderShadows() {
          const tbody = document.getElementById("shadows-tbody");
          if (!tbody) {
            console.error("shadows-tbody element not found");
            return;
          }
          
          const shadows = this.exportData.shadows;

          if (Object.keys(shadows).length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="empty-state"><h3>No shadow styles found</h3><p>Create effect styles in your Figma file to see them here.</p></td></tr>';
            return;
          }

          let html = "";

          Object.entries(shadows).forEach(([styleName, shadowData]) => {
            const itemId = `shadow_${styleName}`;
            const isSelected = this.selectedItems.shadows.has(itemId);

            html += `
                      <tr data-id="${itemId}" data-section="shadows">
                          <td class="checkbox-col">
                              <input type="checkbox" ${
                                isSelected ? "checked" : ""
                              } data-id="${itemId}">
                          </td>
                          <td>${this.escapeHtml(styleName)}</td>
                          <td><span class="type-badge type-${shadowData.type}">${
              shadowData.type
            }</span></td>
                          <td>${this.renderColorValue(shadowData.color)}</td>
                          <td>${shadowData.offset.x}px, ${shadowData.offset.y}px</td>
                          <td>${shadowData.blur}px</td>
                          <td>${
                            shadowData.spread !== undefined
                              ? shadowData.spread + "px"
                              : "-"
                          }</td>
                      </tr>
                  `;
          });

          tbody.innerHTML = html;
          this.setupCheckboxListeners("shadows");
        }

        renderValue(value, type) {
          if (type === "color") {
            return this.renderColorValue(value);
          }

          if (typeof value === "string" && value.length > 50) {
            return `<span class="value-cell" title="${this.escapeHtml(
              value
            )}">${this.escapeHtml(value.substring(0, 50))}...</span>`;
          }

          return `<span class="value-cell">${this.escapeHtml(String(value))}</span>`;
        }

        renderColorValue(color) {
          return `
                  <div class="color-value">
                      <div class="color-swatch" style="background-color: ${color}"></div>
                      <span class="value-cell">${color}</span>
                  </div>
              `;
        }

        renderLineHeight(lineHeight) {
          if (lineHeight === "auto") {
            return '<span class="value-cell">auto</span>';
          }
          return `<span class="value-cell">${lineHeight}</span>`;
        }

        setupCheckboxListeners(section) {
          const checkboxes = document.querySelectorAll(
            `[data-section="${section}"] input[type="checkbox"]`
          );
          checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", (e) => {
              const itemId = e.target.dataset.id;
              this.toggleItem(section, itemId, e.target.checked);
            });
          });
        }

        toggleItem(section, itemId, checked) {
          console.log(section, itemId, checked);
          if (checked) {
            this.selectedItems[section].add(itemId);
          } else {
            this.selectedItems[section].delete(itemId);
          }
          this.updateSelectionCount();
          this.updateSelectAllCheckbox(section);
        }

        toggleSelectAll(section, checked) {
          const checkboxes = document.querySelectorAll(
            `[data-section="${section}"] input[type="checkbox"]`
          );
          checkboxes.forEach((checkbox) => {
            checkbox.checked = checked;
            const itemId = checkbox.dataset.id;
            if (checked) {
              this.selectedItems[section].add(itemId);
            } else {
              this.selectedItems[section].delete(itemId);
            }
          });
          this.updateSelectionCount();
          this.updateSelectAllCheckbox(section);
        }

        selectAll(section) {
          this.toggleSelectAll(section, true);
        }

        deselectAll(section) {
          this.toggleSelectAll(section, false);
        }

        updateSelectAllCheckbox(section) {
          const sectionCheckboxes = document.querySelectorAll(
            `[data-section="${section}"] input[type="checkbox"]`
          );
          const selectAllCheckbox = document.getElementById(`${section}-select-all`);

          if (sectionCheckboxes.length === 0) return;

          const checkedCount = Array.from(sectionCheckboxes).filter(
            (cb) => cb.checked
          ).length;

          if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else if (checkedCount === sectionCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
          }
        }

        updateSelectionCount() {
          const totalSelected =
            this.selectedItems.variables.size +
            this.selectedItems.textStyles.size +
            this.selectedItems.shadows.size;

          const countElement = document.getElementById("selection-count");
          const exportBtn = document.getElementById("export-btn");

          countElement.textContent = `${totalSelected} item${
            totalSelected !== 1 ? "s" : ""
          } selected`;
          exportBtn.disabled = totalSelected === 0;
        }

        exportSelected() {
          const selectedData = {
            variables: {},
            textStyles: {},
            shadows: {},
          };

          // Collect selected variables
          this.selectedItems.variables.forEach((itemId) => {
            const [_, collectionName, varName] = itemId.split("_");
            if (!selectedData.variables[collectionName]) {
              selectedData.variables[collectionName] = {};
            }
            selectedData.variables[collectionName][varName] =
              this.exportData.variables[collectionName][varName];
          });

          // Collect selected text styles
          this.selectedItems.textStyles.forEach((itemId) => {
            // Remove the 'text_' prefix and reverse the sanitization
            const safeStyleName = itemId.replace(/^text_/, "");
            // Find the original style name by matching sanitized names
            const originalStyleName = Object.keys(this.exportData.textStyles).find(
              name => name.replace(/[^a-zA-Z0-9_-]/g, '_') === safeStyleName
            );
            if (originalStyleName) {
              selectedData.textStyles[originalStyleName] =
                this.exportData.textStyles[originalStyleName];
            }
          });

          // Collect selected shadows
          this.selectedItems.shadows.forEach((itemId) => {
            const [_, styleName] = itemId.split("_");
            selectedData.shadows[styleName] = this.exportData.shadows[styleName];
          });

          // Create and download JSON file
          const jsonString = JSON.stringify(selectedData, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `figma-tokens-${new Date().toISOString().split("T")[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // Initialize the UI when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new TokenExportUI();
      });
    </script>
  </body>
</html>
